#!/usr/bin/env ruby
require 'thor'

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'putsreq/version'
require 'httparty'
require 'uri'

class PutsReqCLI < Thor
  no_commands do
    def parse_bucket_token(token)
      if token.start_with? 'http'
        # from http://putsreq.com/token or http://putsreq.com/token/inspect
        # to token
        uri = URI(token)
        return uri.path.split('/')[1]
      end

      token
    end

    def base_url
      'http://localhost:3000/'
      # https://putsreq.com/
    end

    def subscribe_and_forward(token, to)
      puts "Listening requests from #{token}"
      puts "Forwarding to #{to}"
      puts 'Press CTRL+c to terminate'

      last_request_id = last_request_id(token)

      loop do
        url = "#{base_url}#{token}/requests.json?last_request_id=#{last_request_id}"

        parsed_response = get(url).parsed_response

        parsed_response.each do |request|
          forward_request(to, request)
          last_request_id = request.dig('_id', '$oid')
        end

        timeout = parsed_response.none? ? 5 : 2.5

        sleep timeout
      end
    end

    def get(url, timeout = 5)
      response = HTTParty.get(url)
      if response.code == 429
        timeout = [30, timeout + 5].min
        sleep timeout
        return get(url, timeout)
      end

      response
    end

    def last_request_id(token)
      url = "#{base_url}#{token}/last.json"
      response = get(url)
      response.parsed_response.dig('_id', '$oid') if response.ok?
    end

    def forward_request(to, request)
      options = { headers:  request['headers'] }
      options[:body] = request['body'] unless request['body'].to_s.empty?

      forward_request = HTTParty.send(
        request['request_method'].downcase.to_sym,
        to,
        options
      )

      puts [
        Time.now,
        request['request_method'],
        forward_request.code
      ].join("\t")
    end

    def find_request(token, id)
      url = "#{base_url}/#{token}/requests/#{id}.json"
      response = get(url)
      response.parsed_response if response.ok?
    end
  end

  desc 'forward', 'Forward requests from PutsReq to a given URL'
  method_option :token, desc: 'PutsReq token',   required: true
  method_option :to,    desc: 'destination URL', required: true
  method_option :id,    desc: 'ID to forward a single request', required: false
  def forward
    trap('SIGINT', 'EXIT')

    token = parse_bucket_token(options[:token])
    to = options[:to]

    if id = options[:id]
      if request = find_request(token, id)
        forward_request(to, request)
      else
        puts "Request #{id} not found"
      end
    else
      subscribe_and_forward(token, to)
    end
  end

  desc 'version', 'Show version'
  def version
    puts "PutsReq #{PutsReq::VERSION}"
  end
end

PutsReqCLI.start
